---
title: "Analyses multivariées"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    theme: readable
    highlight: tango
    #code_folding: show
    number_sections: true
---

```{r initial_chunk1, echo = FALSE, warning = FALSE, message = FALSE}
library("knitr")
opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE, fig.align = 'center', #dpi = 300, 
               out.width = '100%', out.height = '100%')
```

```{r test-main, child = 'child_source.Rmd'}
```

```{r lib}
library(sf)
library(plotly)
```

# Localisation des accidents en 2018

```{r}
### Shapefiles via data.gouv.fr
# https://www.data.gouv.fr/fr/datasets/contours-des-regions-francaises-sur-openstreetmap/
# https://www.data.gouv.fr/fr/datasets/contours-des-departements-francais-issus-d-openstreetmap/

# dir.create("shapefiles")

## French departements
# download.file(
#    url = "http://osm13.openstreetmap.fr/~cquest/openfla/export/departements-20140306-100m-shp.zip",
#    destfile = "shapefiles/departements-20140306-100m-shp.zip"
#  )
#  unzip(zipfile = "shapefiles/departements-20140306-100m-shp.zip",
#        exdir = "shapefiles/departements-20140306-100m-shp")

# load shapefile data
departements <- st_read(dsn = "../data/shapefiles/departements-20140306-100m-shp/")

# Population par département
pop_dep <- read.csv2("../data/departements.csv")

# Ajout d'un zero
pop_dep <- pop_dep %>% 
  mutate(Code = stri_pad_left(str = Code, width = 2, pad = 0))
```


```{r, out.width="100%"}
# Nombre d'accidents par département
map_data <- caract %>% 
  group_by(dep) %>% 
  summarise(n = n())

# Join avec le shapefile pour récupérer la geometry
map_data <- merge(
  x = map_data,
  y = departements,
  by.x = "dep",
  by.y = "code_insee",
  all.x = TRUE)

# Join avec la population par département
map_data <- merge(
  x = map_data,
  y = pop_dep,
  by.x = "dep",
  by.y = "Code",
  all.x = TRUE)

# Ajout du taux d'accident pour 1000 habitant par département
map_data <- map_data %>% 
  mutate(tx = round(n/Population*1000,2),
         text = paste0(Département, "\n", "Nombre d'accidents pour 1000 habitant :", tx)#,
         # bin = case_when(
         #   tx < 0.45 ~ "0.37 - 0.45",
         #   tx >= 0.45 & tx < 0.48 ~ "0.45 - 0.48",
         #   tx >= 0.48 & tx < 0.54 ~ "0.48 - 0.54",
         #   tx >= 0.54 & tx < 0.63 ~ "0.54 - 0.63",
         #   tx >= 0.63 & tx < 0.67 ~ "0.63 - 0.67",
         #   tx >= 0.67 & tx < 0.72 ~ "0.67 - 0.72",
         #   tx >= 0.72 & tx < 0.77 ~ "0.72 - 0.77",
         #   tx >= 0.77 & tx < 0.91 ~ "0.77 - 0.91",
         #   tx >= 0.91 & tx < 1.13 ~ "0.91 - 1.13",
         #   tx >= 1.13 ~ "1.13 - 2.55"
         # )
         )
  
# map
map <- ggplot(data = map_data) +
  geom_sf(aes(geometry = geometry, fill = tx, text = text), color = "darkgrey", size = 0.1) +
  scale_fill_gradient(low = "darkgreen", high = "#660000", na.value = NA) +
  labs(x = "", 
       y = "", 
       title = "Nombre d'accidents pour 1000 habitants par département en 2018",
       fill = "") +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    plot.margin = margin(0,0,0,0)
  )

ggplotly(map, tooltip = "text") %>% 
  # layout(legend = list(orientation = "h", x = 0, y = 0)) %>% 
  config(displayModeBar = F) 

# A tester avec leaflet
```

# Analyse des risques selon la place dans le véhicule

```{r}
# Filtre sur les voitures
voitures <- vehic %>% 
  filter(catv == "VL seul")

# Jointure avec usagers
heatmap <- merge(
  x = usag,
  y = voitures,
  by = "Num_Acc"
)

heatmap <- heatmap %>% 
  filter(catu %in% c("Conducteur", "Passager")) %>% 
  group_by(place) %>% 
  mutate(total_group = n()) %>% 
  group_by(place, grav, total_group) %>% 
  summarise(cnt_cat = n()) %>% 
  mutate(perc = round(cnt_cat / total_group * 100, 1),
         text = paste0("Place ", place, "\n", grav, " : ", perc, "%", "\n", "Nombre d'usagers : ", cnt_cat))

heatmap <- heatmap %>% 
  mutate(
    lignes = case_when(
    place == 1 ~ 3,
    place == 2 ~ 1,
    place == 3 ~ 1,
    place == 4 ~ 3,
    place == 5 ~ 2,
    place == 6 ~ 2,
    place == 7 ~ 3,
    place == 8 ~ 2,
    place == 9 ~ 1
  ),
  colonnes = case_when(
    place == 1 ~ 3,
    place == 2 ~ 3,
    place == 3 ~ 1,
    place == 4 ~ 1,
    place == 5 ~ 1,
    place == 6 ~ 3,
    place == 7 ~ 2,
    place == 8 ~ 2,
    place == 9 ~ 2
  ))
```

```{r, out.width="100%"}
# Usager = Tué
vehic_heatmap <- ggplot(data = heatmap %>% filter(grav == "Tué"), 
                        mapping = aes(x = colonnes, y = lignes, fill = perc, text = text)) +
  geom_tile() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  ) +
  scale_fill_gradient(low = "#da3349", high = "#660000") +
  labs(
    title = "Pourcentage de décès selon la place dans le véhicule",
    fill = ""
  )

ggplotly(vehic_heatmap, tooltip = "text") %>% config(displayModeBar = F)
```

```{r, out.width="100%"}
# Usager = hospitalisé
vehic_heatmap <- ggplot(data = heatmap %>% filter(grav == "Blessé hospitalisé"), 
                        mapping = aes(x = colonnes, y = lignes, fill = perc, text = text)) +
  geom_tile() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  ) +
  scale_fill_gradient(low = "#da3349", high = "#660000") +
  labs(
    title = "Pourcentage de blessés hospitalisés\n selon la place dans le véhicule",
    fill = ""
  )

ggplotly(vehic_heatmap, tooltip = "text") %>% config(displayModeBar = F)
```

```{r, out.width="100%"}
# Usager = blessés légers
vehic_heatmap <- ggplot(data = heatmap %>% filter(grav == "Blessé léger"), 
                        mapping = aes(x = colonnes, y = lignes, fill = perc, text = text)) +
  geom_tile() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  ) +
  scale_fill_gradient(low = "#da3349", high = "#660000") +
  labs(
    title = "Pourcentage de blessés légers\n selon la place dans le véhicule",
    fill = ""
  )

ggplotly(vehic_heatmap, tooltip = "text") %>% config(displayModeBar = F)
```

```{r, out.width="100%"}
# Usager = indemne
vehic_heatmap <- ggplot(data = heatmap %>% filter(grav == "Indemne"), 
                        mapping = aes(x = colonnes, y = lignes, fill = perc, text = text)) +
  geom_tile() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  ) +
  scale_fill_gradient(low = "#da3349", high = "#660000") +
  labs(
    title = "Pourcentage d'usagers indemnes\n selon la place dans le véhicule",
    fill = ""
  )

ggplotly(vehic_heatmap, tooltip = "text") %>% config(displayModeBar = F)
```

# Analyse des accidents

## Pourcentage d'accidents impliquants des piétons

## Pourcentage d'accidents impliquants un autre véhicule

# Analyse des usagers

taux mortalité par age x catégorie usagers


## Conducteurs
âge

## Piétons
âge

## Nombre de personnes par voiture + moto etc en moyenne

# Analyse des sources de danger

## Quels sont les types de voies les plus dangereuses ?

## Quel est le type d'intersection le plus dangereux ?

## Nombre de tués ou blessée hospitalisés vs nb total d'accident

## Quel est l'impact de l'état de la voie sur le nombre d'accident ?

## Quel est l'impact de l'état de la voie sur le taux de mortalité ?


## Quel est l'impact du moment de la journée sur le nombre d'accidents ?

```{r}
# Nombre d'accidents en fonction du moment de la journée
caract %>% 
  group_by(lum) %>% 
  summarise(nb_accidents = n()) %>% 
  ggplot(aes(x = fct_reorder(lum, nb_accidents), y = nb_accidents)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(
    x = "",
    y = "Nombre d'accidents"
  )
```


## Quel est l'impact du moment de la journée sur le taux de mortalité ?
```{r}
# Nombre d'accidents graves en fonction du moment de la journée
day_grav <- merge(
  x = usag,
  y = caract,
  by = "Num_Acc"
)

# filtre de façon à ne conserver que le blessé le plus grave pour chaque accident

day_grav %>% 
  mutate(grav = factor(grav, levels = c("Tué", "Blessé hospitalisé", "Blessé léger", "Indemne")),
         lum = factor(lum, levels = c("Crépuscule ou aube", "Plein jour", "Nuit avec éclairage public allumé", "Nuit avec éclairage public non allumé", "Nuit sans éclairage public")
)) %>% 
  arrange(Num_Acc, grav) %>% 
  group_by(Num_Acc) %>% 
  mutate(rank = seq(1:n())) %>% 
  filter(rank == 1) %>% 
  ungroup() %>% 
  group_by(lum, grav) %>% 
  summarise(nb_accidents = n()) %>% 
  ggplot(aes(x = fct_reorder(lum, nb_accidents), y = nb_accidents, fill = grav)) +
  geom_bar(position = "fill", stat = "identity") +
  coord_flip() +
  labs(
    title = "Distribution de la gravité de l'accident en fonction du moment de la journée",
    subtitle = "Focus sur le blessé le plus grave rattaché à l'accident",
    x = "",
    y = "Nombre d'accidents"
  )

# to do : changer les couleurs
```

Test de student / comparaison de moyenne
box plots

# est-ce que le temps est un facteur aggravant ?

## Quels sont les véhicules les plus dangereux ?
Les plus impliqués dans des accidents ?



