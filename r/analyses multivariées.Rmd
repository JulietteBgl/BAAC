---
title: "Analyses multivariées"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    theme: readable
    highlight: tango
    #code_folding: show
    number_sections: true
---

```{r initial_chunk1, echo = FALSE, warning = FALSE, message = FALSE}
library("knitr")
opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE, fig.align = 'center', #dpi = 300, 
               out.width = '100%', out.height = '100%')
```

```{r test-main, child = 'child_source.Rmd'}
```

```{r lib}
library(sf)
library(plotly)
```

# Localisation des accidents en 2018

```{r}
### Shapefiles via data.gouv.fr
# https://www.data.gouv.fr/fr/datasets/contours-des-regions-francaises-sur-openstreetmap/
# https://www.data.gouv.fr/fr/datasets/contours-des-departements-francais-issus-d-openstreetmap/

# dir.create("shapefiles")

## French departements
# download.file(
#    url = "http://osm13.openstreetmap.fr/~cquest/openfla/export/departements-20140306-100m-shp.zip",
#    destfile = "shapefiles/departements-20140306-100m-shp.zip"
#  )
#  unzip(zipfile = "shapefiles/departements-20140306-100m-shp.zip",
#        exdir = "shapefiles/departements-20140306-100m-shp")

# load shapefile data
departements <- st_read(dsn = "../data/shapefiles/departements-20140306-100m-shp/")

# Population par département
pop_dep <- read.csv2("../data/departements.csv")

# Ajout d'un zero
pop_dep <- pop_dep %>% 
  mutate(Code = stri_pad_left(str = Code, width = 2, pad = 0))
```


```{r fig.height=10, fig.width=15}
# Nombre d'accidents par département
map_data <- caract %>% 
  group_by(dep) %>% 
  summarise(n = n())

# Join avec le shapefile pour récupérer la geometry
map_data <- merge(
  x = map_data,
  y = departements,
  by.x = "dep",
  by.y = "code_insee",
  all.x = TRUE)

# Join avec la population par département
map_data <- merge(
  x = map_data,
  y = pop_dep,
  by.x = "dep",
  by.y = "Code",
  all.x = TRUE)

# Ajout du taux d'accident pour 1000 habitant par département
map_data <- map_data %>% 
  mutate(tx = round(n/Population*1000,2),
         text = paste0(Département, "\n", "Nombre d'accidents pour 1000 habitant :", tx))
  
# map
map <- ggplot(data = map_data) +
  geom_sf(aes(geometry = geometry, fill = tx, text = text)) +
  scale_fill_gradient(low = "lightgreen", high = "red", na.value = NA) +
  labs(x = "", 
       y = "", 
       title = "Nombre d'accidents pour 1000 habitants par département en 2018",
       fill = "") +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  )

ggplotly(map, tooltip = "text") %>% config(displayModeBar = F)

```

To do : récupérer la pop par département 

# Analyse des risques selon la place dans le véhicule

```{r}
# Filtre sur les voitures
voitures <- vehic %>% 
  filter(catv == "VL seul")

# Jointure avec usagers
heatmap <- merge(
  x = usag,
  y = voitures,
  by = "Num_Acc"
)

heatmap <- heatmap %>% 
  filter(catu %in% c("Conducteur", "Passager")) %>% 
  group_by(place) %>% 
  mutate(total_group = n()) %>% 
  group_by(place, grav, total_group) %>% 
  summarise(cnt_cat = n()) %>% 
  mutate(perc = round(cnt_cat / total_group * 100, 1),
         text = paste0("Place ", place, "\n", grav, " : ", perc, "%", "\n", "Nombre d'usagers : ", cnt_cat))

heatmap <- heatmap %>% 
  mutate(
    lignes = case_when(
    place == 1 ~ 3,
    place == 2 ~ 1,
    place == 3 ~ 1,
    place == 4 ~ 3,
    place == 5 ~ 2,
    place == 6 ~ 2,
    place == 7 ~ 3,
    place == 8 ~ 2,
    place == 9 ~ 1
  ),
  colonnes = case_when(
    place == 1 ~ 3,
    place == 2 ~ 3,
    place == 3 ~ 1,
    place == 4 ~ 1,
    place == 5 ~ 1,
    place == 6 ~ 3,
    place == 7 ~ 2,
    place == 8 ~ 2,
    place == 9 ~ 2
  ))
```

```{r, fig.width = 10, fig.height = 7}
# Usager = Tué
vehic_heatmap <- ggplot(data = heatmap %>% filter(grav == "Tué"), 
                        mapping = aes(x = colonnes, y = lignes, fill = perc, text = text)) +
  geom_tile() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  ) +
  scale_fill_gradient(low = "#da3349", high = "#660000") +
  labs(
    title = "Pourcentage de décès selon la place dans le véhicule",
    fill = ""
  )

ggplotly(vehic_heatmap, tooltip = "text") %>% config(displayModeBar = F)
```

```{r, fig.width = 10, fig.height = 7}
# Usager = hospitalisé
vehic_heatmap <- ggplot(data = heatmap %>% filter(grav == "Blessé hospitalisé"), 
                        mapping = aes(x = colonnes, y = lignes, fill = perc, text = text)) +
  geom_tile() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  ) +
  scale_fill_gradient(low = "#da3349", high = "#660000") +
  labs(
    title = "Pourcentage de blessés hospitalisés\n selon la place dans le véhicule",
    fill = ""
  )

ggplotly(vehic_heatmap, tooltip = "text") %>% config(displayModeBar = F)
```

```{r, fig.width = 10, fig.height = 7}
# Usager = blessés légers
vehic_heatmap <- ggplot(data = heatmap %>% filter(grav == "Blessé léger"), 
                        mapping = aes(x = colonnes, y = lignes, fill = perc, text = text)) +
  geom_tile() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  ) +
  scale_fill_gradient(low = "#da3349", high = "#660000") +
  labs(
    title = "Pourcentage de blessés légers\n selon la place dans le véhicule",
    fill = ""
  )

ggplotly(vehic_heatmap, tooltip = "text") %>% config(displayModeBar = F)
```

```{r, fig.width = 10, fig.height = 7}
# Usager = indemne
vehic_heatmap <- ggplot(data = heatmap %>% filter(grav == "Indemne"), 
                        mapping = aes(x = colonnes, y = lignes, fill = perc, text = text)) +
  geom_tile() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  ) +
  scale_fill_gradient(low = "#da3349", high = "#660000") +
  labs(
    title = "Pourcentage d'usagers indemnes\n selon la place dans le véhicule",
    fill = ""
  )

ggplotly(vehic_heatmap, tooltip = "text") %>% config(displayModeBar = F)
```

# Analyse des accidents

## Pourcentage d'accidents impliquants des piétons

## Pourcentage d'accidents impliquants un autre véhicule

# Analyse des usagers

taux mortalité par age x catégorie usagers


## Conducteurs
âge

## Piétons
âge

# Analyse des sources de danger

## Quels sont les types de voies les plus dangereuses ?

## Quel est le type d'intersection le plus dangereux ?


## Quel est l'impact de l'état de la voie sur le nombre d'accident ?

## Quel est l'impact de l'état de la voie sur le taux de mortalité ?


## Quel est l'impact du moment de la journée sur le nombre d'accidents ?

## Quel est l'impact du moment de la journée sur le taux de mortalité ?


Test de student / comparaison de moyenne
box plots



## Quels sont les véhicules les plus dangereux ?



